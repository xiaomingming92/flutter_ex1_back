- name: Deploy to server
  run: |
    ssh -p 168 \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
      export VOLTA_HOME="$HOME/.volta"
      export PATH="$VOLTA_HOME/bin:$PATH"

      cd $HOME/Sites/flutter_ex1_back

      git pull origin main
      export HUSKY=0
      npm install
      npm run build:prod || exit 1

      APP_NAME="${{ secrets.SERVER_PM2_NAME }}"
      ENTRY_FILE="dist/index.js"

      # PM2 部署逻辑：优先 reload，其次 restart，最后 start
      if pm2 describe "$APP_NAME" > /dev/null; then
        pm2 reload "$APP_NAME" --update-env || pm2 restart "$APP_NAME" --update-env
      else
        pm2 start "$ENTRY_FILE" --name "$APP_NAME"
      fi

      echo "$(date +"%Y-%m-%d %H:%M:%S") - 服务部署并重启成功" >> $HOME/Sites/deploy.log
    EOF
