stages:
  - build
  - deploy

variables:
  # 让 Volta 在容器里生效
  VOLTA_HOME: /usr/local/volta
  PATH: '$VOLTA_HOME/bin:$PATH'
  HUSKY: 0
  APP_NAME: flutter_ex1_back
  RUN_DIR: /home/xmm/Sites/flutter_ex1_back # 宿主机真实目录
  ENTRY_FILE: /home/xmm/Sites/flutter_ex1_back/dist/index.js

build-job:
  image: gitlab-runner-node-ex1:latest
  stage: build
  tags: ['ex1-api'] # 必须落在同一台宿主机
  only:
    - main
  before_script:
    # 确保容器里有 volta
    # - echo "volta version: $(volta --version)"
  script:
    # 1. 依赖安装 & 构建
    - npm ci
    - source "$RUN_DIR/.env.local"
    - npm run build:prod
  artifacts:
    paths:
      - dist/
    expire_in: 1 day

deploy-job:
  image: gitlab-runner-node-ex1:latest
  stage: deploy
  tags: ['ex1-api'] # 必须落在同一台宿主机
  only:
    - main
  dependencies:
    - build-job
  before_script: # 确保容器里有 rsync、ssh（可选）
    # - apt update && apt install -y --no-install-recommends rsync openssh-client && rm -rf /var/lib/apt/lists/*
  script:
    # 1. 产物/配置同步
    - rsync -av --delete dist/ "$RUN_DIR/dist/"
    - rsync -av package*.json "$RUN_DIR/"
    - rsync -av prisma "$RUN_DIR/"
    - rsync -av ecosystem.config.cjs "$RUN_DIR/"

    # 2. PM2 重载
    - cd "$RUN_DIR"
    # - |
    #   if pm2 describe "$APP_NAME" >/dev/null 2>&1; then
    #     pm2 reload "$APP_NAME" --update-env
    #   else
    #     pm2 start "$ENTRY_FILE" --name "$APP_NAME"
    #   fi
    - pm2 start ecosystem.config.cjs --only "$APP_NAME" --update-env --env production
    - pm2 save

    # 3. 留痕
    - echo "$(date '+%F %T') deploy finished"
    - echo "$(date '+%F %T') deploy ok" >> "$RUN_DIR/deploy.log"
