generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(uuid())
  username  String?   @unique
  phone     String?   @unique
  password  String
  name      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  articles  Article[]
  avatar    String?
  bio       String
  
  // ✅ 多对多关系：用户-角色
  roles     Role[]
  
  @@map("users")
}

model Role {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // ✅ 多对多关系：角色-用户
  users       User[]
  
  // ✅ 多对多关系：角色-权限（权益自由组合）
  permissions Permission[]
  
  @@map("roles")
}

model Permission {
  id            String    @id @default(uuid())
  name          String    @unique      // 权限名称：如"创建文章"
  description   String?                // 权限描述
  category      String                 // 权限分类：如"article" 
  action        String                 // 权限动作：如"create"
  code          String    @unique      // 完整权限代码：如"article.create"（自动生成）
  isActive      Boolean   @default(true) // 是否启用
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // ✅ 多对多关系：权限-角色
  roles         Role[]
  
  @@map("permissions")
}




model Article {
  id            String         @id @default(uuid())
  title         String
  content       String         @db.Text
  authorId      String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  author        User           @relation(fields: [authorId], references: [id], onDelete: Restrict)
  waterfallItem WaterfallItem?
  media         ArticleMedia[]

  @@index([authorId], map: "articles_authorId_fkey")
  @@map("articles")
}

model Image {
  id             String          @id @default(uuid())
  url            String
  width          Int?
  height         Int?
  filename       String?
  mimeType       String?
  size           Int?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  waterfallItems WaterfallItem[]
  articleMedia   ArticleMedia[]

  @@map("images")
}

model WaterfallItem {
  id          String   @id @default(uuid())
  description String?  @db.Text
  articleId   String   @unique
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  imageId     String?
  article     Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  image       Image?   @relation(fields: [imageId], references: [id])

  @@index([sortOrder, createdAt])
  @@index([imageId], map: "waterfall_items_imageId_fkey")
  @@map("waterfall_items")
}

model ArticleMedia {
  id        String   @id @default(uuid())
  articleId String
  imageId   String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  image     Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([imageId])
  @@map("article_media")
}

model UserToken {
  id               String    @id @default(uuid())
  userId           String
  accessToken      String    @db.VarChar(255)
  refreshToken     String    @unique @db.VarChar(255)
  accessExpiresAt  DateTime
  refreshExpiresAt DateTime
  createdAt        DateTime  @default(now())
  revokedAt        DateTime?

  @@index([userId])
  @@index([accessToken])
  @@map("user_tokens")
}




